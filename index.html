<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å¿ƒæƒ…æ—¥è¨˜ (Anchor Fix)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=cwTeXYen&display=swap" rel="stylesheet">

<style>
    /* STYLES */
    :root { --primary: #ff9800; --bg: #fff8e1; --text: #5d4037; }
    body { font-family: 'cwTeXYen', sans-serif; background: var(--bg); color: var(--text); padding: 15px; user-select: none; }
    .container { max-width: 800px; margin: 0 auto; background: white; border: 4px dashed var(--primary); border-radius: 20px; padding: 15px; }
    h1 { text-align: center; color: var(--primary); margin: 5px 0 15px 0; }
    .section { background: #fff; border: 2px solid #eee; border-radius: 15px; padding: 15px; margin-bottom: 20px; }
    
    /* TEXTBOX - THE ANCHOR */
    textarea { 
        width: 100%; padding: 15px; border: 3px solid #ddd; border-radius: 12px; 
        font-size: 1.4rem; font-family: inherit; box-sizing: border-box; 
        background: #fafafa; outline: none; min-height: 150px;
    }
    textarea:focus { border-color: var(--primary); }
    textarea.listening { border-color: #ff5252; background: #fff5f5; box-shadow: 0 0 10px rgba(255, 82, 82, 0.3); }

    /* BUTTONS */
    .btn { width: 100%; padding: 15px; margin: 5px 0; border: none; border-radius: 12px; font-size: 1.2rem; cursor: pointer; color: white; display: flex; justify-content: center; gap: 10px; font-weight: bold; }
    .btn-mic { background: #ff5252; box-shadow: 0 5px 0 #b71c1c; }
    .btn-mic.active { background: #d32f2f; animation: pulse 1.5s infinite; }
    .btn-read { background: #42a5f5; box-shadow: 0 5px 0 #1565c0; }
    .btn-save { background: #4caf50; box-shadow: 0 5px 0 #2e7d32; margin-top: 15px; }
    .btn:active { transform: translateY(4px); box-shadow: none !important; }

    /* TOOLS */
    input, select { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 10px; font-size: 1.2rem; margin-bottom: 10px; box-sizing: border-box; }
    .tool-row { display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto; }
    .tool-btn { min-width: 50px; height: 50px; background: white; border: 2px solid #eee; border-radius: 50%; font-size: 1.5rem; }
    canvas { border: 2px solid #ccc; border-radius: 10px; width: 100%; height: auto; background: white; touch-action: none; }

    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
</style>
</head>
<body>

<div class="container">
    <h1>ğŸŒ å¿ƒæƒ…æ—¥è¨˜</h1>

    <div class="section">
        <input type="date" id="dateInput">
        <select id="locationSelect">
            <option value="å­¸æ ¡">ğŸ« å­¸æ ¡</option>
            <option value="å±‹ä¼">ğŸ  å±‹ä¼</option>
            <option value="å…¬åœ’">ğŸŒ³ å…¬åœ’</option>
        </select>
    </div>

    <div class="section">
        <h3>ğŸ—£ï¸ äº‹æƒ… (èªéŸ³è¼¸å…¥)</h3>
        <button id="btnMic" class="btn btn-mic" onclick="toggleMic()">
            <i class="fas fa-microphone"></i> æŒ‰æ­¤èªªè©± / åœæ­¢
        </button>
        <textarea id="textBox" placeholder="..."></textarea>
        <button class="btn btn-read" onclick="speakText()">
            <i class="fas fa-volume-up"></i> æœ—è®€æª¢æŸ¥
        </button>
    </div>

    <div class="section">
        <h3>ğŸ¨ ç•«æ¿</h3>
        <div class="tool-row">
            <button class="tool-btn" onclick="setMode('brush')">ğŸ–Œï¸</button>
            <button class="tool-btn" onclick="setMode('eraser')">ğŸ§½</button>
            <button class="tool-btn" onclick="clearCanvas()">ğŸ—‘ï¸</button>
            <button class="tool-btn" style="background:black;" onclick="setColor('black')"></button>
            <button class="tool-btn" style="background:#e91e63;" onclick="setColor('#e91e63')"></button>
            <button class="tool-btn" style="background:#2196f3;" onclick="setColor('#2196f3')"></button>
        </div>
        <canvas id="canvas" width="800" height="400"></canvas>
    </div>

    <button class="btn btn-save" onclick="saveData()">ğŸ’¾ å„²å­˜æ—¥è¨˜</button>
</div>

<audio id="popSound" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>

<script>
    document.getElementById('dateInput').valueAsDate = new Date();
    function playPop() { document.getElementById('popSound').play().catch(()=>{}); }

    // --- CRITICAL FIX: THE ANCHOR VARIABLE ---
    let recognition;
    let isListening = false;
    let anchorText = ""; // This holds "Sentence 1" while we speak "Sentence 2"

    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.lang = 'zh-HK';
        recognition.continuous = true; 
        recognition.interimResults = true; 

        // 1. START: LOCK THE ANCHOR
        recognition.onstart = function() {
            isListening = true;
            playPop();
            document.getElementById('btnMic').classList.add('active');
            document.getElementById('textBox').classList.add('listening');
            document.getElementById('btnMic').innerHTML = '<i class="fas fa-stop"></i> æ”¶éŸ³ä¸­...';
            
            // KEY FIX: Before we start listening, grab exactly what is in the box NOW.
            anchorText = document.getElementById('textBox').value;
            
            // Add a polite space if there isn't one
            if (anchorText.length > 0 && ![' ', 'ï¼Œ', 'ã€‚', '\n'].includes(anchorText.slice(-1))) {
                anchorText += " ";
            }
        };

        // 2. RESULT: GLUE NEW WORDS TO ANCHOR
        recognition.onresult = function(event) {
            let newWords = "";
            
            // Gather all the new words from this specific session
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                newWords += event.results[i][0].transcript;
            }

            // CRITICAL: Overwrite the box with ANCHOR + NEW WORDS
            // This ensures we never lose the Anchor (Sentence 1), and we see Sentence 2 forming instantly.
            document.getElementById('textBox').value = anchorText + newWords;
            
            // Force scroll to see new words
            document.getElementById('textBox').scrollTop = document.getElementById('textBox').scrollHeight;
        };

        // 3. END: RESET UI (Don't auto-restart, let user tap)
        recognition.onend = function() {
            isListening = false;
            document.getElementById('btnMic').classList.remove('active');
            document.getElementById('textBox').classList.remove('listening');
            document.getElementById('btnMic').innerHTML = '<i class="fas fa-microphone"></i> æŒ‰æ­¤èªªè©± / åœæ­¢';
            
            // Final Sync: Just in case, update anchor to match reality
            anchorText = document.getElementById('textBox').value;
        };
        
        recognition.onerror = function(e) {
            console.log("Error", e);
            isListening = false;
            document.getElementById('btnMic').classList.remove('active');
            document.getElementById('textBox').classList.remove('listening');
        };
    }

    function toggleMic() {
        if (!recognition) return alert("Please use Chrome/Safari");
        if (isListening) recognition.stop();
        else recognition.start();
    }

    // --- EXPORT & DRAWING ---
    function speakText() { 
        if(!document.getElementById('textBox').value) return;
        let u = new SpeechSynthesisUtterance(document.getElementById('textBox').value);
        u.lang = 'zh-HK'; window.speechSynthesis.speak(u);
    }

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = "white"; ctx.fillRect(0,0,800,400); ctx.lineCap = "round"; ctx.lineJoin = "round";
    let isDrawing = false; let color = "black"; let size = 5;

    function setMode(m) { if(m==='eraser'){ctx.globalCompositeOperation="destination-out"; size=30;}else{ctx.globalCompositeOperation="source-over"; ctx.strokeStyle=color; size=5;} }
    function setColor(c) { color=c; setMode('brush'); }
    function clearCanvas() { ctx.globalCompositeOperation="source-over"; ctx.fillStyle="white"; ctx.fillRect(0,0,800,400); }
    
    function getPos(e) { 
        const r = canvas.getBoundingClientRect(); 
        const x = e.touches?e.touches[0].clientX:e.clientX; const y = e.touches?e.touches[0].clientY:e.clientY;
        return {x:(x-r.left)*(800/r.width), y:(y-r.top)*(400/r.height)};
    }
    function start(e){e.preventDefault(); isDrawing=true; ctx.beginPath(); const p=getPos(e); ctx.moveTo(p.x,p.y); ctx.lineWidth=size;}
    function move(e){if(!isDrawing)return; e.preventDefault(); const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke();}
    function end(){isDrawing=false;}
    
    canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); canvas.addEventListener('mouseup', end);
    canvas.addEventListener('touchstart', start, {passive:false}); canvas.addEventListener('touchmove', move, {passive:false}); canvas.addEventListener('touchend', end);

    function saveData() {
        const d = document.getElementById('dateInput').value;
        const t = document.getElementById('textBox').value;
        const csv = `\uFEFFæ—¥æœŸ,å…§å®¹\n${d},${t}`;
        const a = document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download=`Diary_${d}.csv`; a.click();
        setTimeout(()=>{
            const a2 = document.createElement('a'); a2.href=canvas.toDataURL('image/jpeg'); a2.download=`Art_${d}.jpg`; a2.click();
        },500);
    }
</script>
</body>
</html>